/*! evtrack -- UI module */
!function(s){var i=s.document,o="mousedown mouseup mousemove mouseover mouseout mousewheel wheel";o+=" touchstart touchend touchmove deviceorientation keydown keyup keypress";var a="load unload beforeunload blur focus resize error abort online offline";a+=" storage popstate hashchange pagehide pageshow message beforeprint afterprint";var o=(o+=" click dblclick scroll change select submit reset contextmenu cut copy paste").split(" "),a=a.split(" "),e=o.concat(a),n=0,r=0,l=[],c={settings:{postServer:"//my.server.org/save.script",postInterval:30,regularEvents:"*",pollingEvents:"",pollingMs:150,taskName:"evtrack",callback:null,saveAttributes:!0,debug:!1},record:function(e){for(var t in r=(new Date).getTime(),c.settings)e.hasOwnProperty(t)&&null!==e[t]&&(c.settings[t]=e[t]);c.log("Recording starts...",r,c.settings),c.addEventListeners(),setTimeout(function(){c.initNewData(!0)},1e3*c.settings.postInterval)},addEventListeners:function(){"*"==c.settings.regularEvents?c.addCustomEventListeners(e):(c.log("Settings regular events..."),c.settings.regularEvents=c.settings.regularEvents.split(" "),c.addCustomEventListeners(c.settings.regularEvents)),"*"==c.settings.pollingEvents?c.addCustomEventListeners(e):(c.log("Settings polling events..."),c.settings.pollingEvents=c.settings.pollingEvents.split(" "),c.addCustomEventListeners(c.settings.pollingEvents)),TrackLib.Events.add(s,"beforeunload",c.flush),TrackLib.Events.add(s,"unload",c.flush)},addCustomEventListeners:function(e){c.log("Adding event listeners:",e);for(var t=0;t<e.length;++t){var n=e[t];n&&(-1<o.indexOf(n)?(TrackLib.Events.add(i,n,c.docHandler),c.log("Adding document event:",n),i.attachEvent&&("focus"==n&&TrackLib.Events.add(i.body,"focusin",c.winHandler),"blur"==n&&TrackLib.Events.add(i.body,"focusout",c.winHandler))):-1<a.indexOf(n)&&(TrackLib.Events.add(s,n,c.winHandler),c.log("Adding window event:",n)))}},initNewData:function(e){var t=TrackLib.Dimension.getWindowSize(),n=TrackLib.Dimension.getDocumentSize(),n={url:encodeURIComponent(s.location.href),screenw:screen.width,screenh:screen.height,winw:t.width,winh:t.height,docw:n.width,doch:n.height,info:encodeURIComponent(l.join("|||")),task:encodeURIComponent(c.settings.taskName),action:"init"};e||"function"!=typeof navigator.sendBeacon?c.send({async:e,postdata:n,callback:c.setUserId}):(n.beacon=!0,n=JSON.stringify(n),navigator.sendBeacon(c.settings.postServer,n)),l=[]},setUserId:function(e){n=e.responseText,c.log("setUserId:",n),n&&setInterval(function(){c.appendData(!0)},1e3*c.settings.postInterval)},appendData:function(e){var t={uid:n,info:encodeURIComponent(l.join("|||")),action:"append"};e||"function"!=typeof navigator.sendBeacon?0<l.length?c.send({async:e,postdata:t}):c.log("Skipping empty request..."):(t.beacon=!0,t=JSON.stringify(t),navigator.sendBeacon(c.settings.postServer,t)),l=[]},send:function(e){e.url=c.settings.postServer,TrackLib.XHR.sendAjaxRequest(e)},docHandler:function(e){-1<e.type.indexOf("touch")?c.touchHandler(e):c.eventHandler(e)},winHandler:function(e){c.eventHandler(e)},eventHandler:function(e){var t,n,s,i,o,a;"isTrusted"in(e=TrackLib.Events.fix(e))&&!e.isTrusted||(t=(new Date).getTime(),n=e.type,a=!0,(a=0<c.settings.pollingMs&&-1<c.settings.pollingEvents.indexOf(n)?t-r>=c.settings.pollingMs:a)&&(s=c.getMousePos(e),i=TrackLib.XPath.getXPath(e.target),o=c.settings.saveAttributes?TrackLib.Util.serializeAttrs(e.target):"{}",a="{}","function"==typeof c.settings.callback&&(a=JSON.stringify(c.settings.callback(e))),"scroll"==n&&(s=TrackLib.Dimension.getScrollingPosition()),c.fillInfo(e.id,t,s.x,s.y,n,i,o,a),r=t))},touchHandler:function(e){if(!("isTrusted"in(e=TrackLib.Events.fix(e)))||e.isTrusted){var t=e.changedTouches;if(t)for(var n,s=0;s<t.length;++s)(n=t[s]).type=e.type,c.eventHandler(n)}},getMousePos:function(e){var t=0,n=0;return(e=TrackLib.Events.fix(e)).pageX||e.pageY?(t=e.pageX,n=e.pageY,_lastPos={x:t,y:n}):(e.clientX||e.clientY)&&(t=e.clientX+i.body.scrollLeft+i.documentElement.scrollLeft,n=e.clientY+i.body.scrollTop+i.documentElement.scrollTop,_lastPos={x:t,y:n}),{x:t=!t||t<0?0:t,y:n=!n||n<0?0:n}},fillInfo:function(e){e=[].slice.apply(arguments);l.push(e.join(" ")),c.log(e)},flush:function(e){var t;for(c.log("Flushing data..."),t=0;t<o.length;++t)TrackLib.Events.remove(i,o[t],c.docHandler);for(t=0;t<a.length;++t)TrackLib.Events.remove(s,a[t],c.winHandler);n?c.appendData(!1):c.initNewData(!1)},log:function(e){c.settings.debug&&"function"==typeof console.log&&console.log.apply(console,arguments)}};s.TrackUI=c}(this);